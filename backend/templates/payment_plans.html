<!doctype html>
<html lang="es">
<head>
    <meta charset='utf-8'>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gesti√≥n de Planes de Pago</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f7fa;
            line-height: 1.6;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px 30px;
            border-radius: 15px;
            margin-bottom: 20px;
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.2);
        }

        .header h2 {
            font-size: 2rem;
            font-weight: 300;
            margin-bottom: 15px;
        }

        .controls {
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }

        .control-group {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .control-input {
            padding: 8px 12px;
            border: 2px solid rgba(255,255,255,0.3);
            border-radius: 8px;
            background: rgba(255,255,255,0.9);
            font-size: 0.95rem;
        }

        .btn {
            padding: 8px 16px;
            background: white;
            color: #667eea;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .stats-bar {
            background: white;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 20px;
        }

        .stat-item {
            text-align: center;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
        }

        .stat-number {
            font-size: 1.8rem;
            font-weight: 700;
            color: #667eea;
            margin-bottom: 5px;
        }

        .stat-label {
            color: #6c757d;
            font-size: 0.85rem;
            text-transform: uppercase;
        }

        .main-grid {
            display: grid;
            grid-template-columns: 300px 1fr;
            gap: 20px;
        }

        .client-list {
            background: white;
            border-radius: 12px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
            overflow: hidden;
        }

        .client-list-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            font-weight: 600;
        }

        .search-box {
            padding: 15px;
            border-bottom: 1px solid #e9ecef;
        }

        .search-input {
            width: 100%;
            padding: 10px;
            border: 2px solid #e1e1e1;
            border-radius: 8px;
            font-size: 0.9rem;
        }

        .search-input:focus {
            outline: none;
            border-color: #667eea;
        }

        .clients-container {
            max-height: calc(100vh - 400px);
            overflow-y: auto;
        }

        .client-item {
            padding: 15px;
            border-bottom: 1px solid #f0f0f0;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .client-item:hover {
            background: #f8f9fa;
        }

        .client-item.active {
            background: #e3f2fd;
            border-left: 4px solid #667eea;
        }

        .client-name {
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 5px;
        }

        .client-info {
            font-size: 0.85rem;
            color: #6c757d;
        }

        .payment-detail {
            background: white;
            border-radius: 12px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
            padding: 30px;
        }

        .detail-header {
            border-bottom: 2px solid #e9ecef;
            padding-bottom: 20px;
            margin-bottom: 25px;
        }

        .client-title {
            font-size: 1.8rem;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 10px;
        }

        .client-meta {
            display: flex;
            gap: 30px;
            color: #6c757d;
        }

        .plan-config {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 25px;
            margin-bottom: 30px;
        }

        .plan-config h3 {
            color: #2c3e50;
            margin-bottom: 20px;
            font-size: 1.3rem;
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-label {
            display: block;
            color: #2c3e50;
            font-weight: 600;
            margin-bottom: 8px;
            font-size: 0.9rem;
        }

        .form-input, .form-select {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e1e1e1;
            border-radius: 8px;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .form-input:focus, .form-select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .payment-schedule {
            margin-top: 30px;
        }

        .payment-schedule h3 {
            color: #2c3e50;
            margin-bottom: 20px;
            font-size: 1.3rem;
        }

        .schedule-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 15px;
        }

        .payment-card {
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            padding: 20px;
            transition: all 0.3s ease;
            position: relative;
        }

        .payment-card:hover {
            border-color: #667eea;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .payment-card.paid {
            border-color: #28a745;
            background: #f0fff4;
        }

        .payment-card.pending {
            border-color: #ffc107;
            background: #fffdf0;
        }

        .payment-card.overdue {
            border-color: #dc3545;
            background: #fff5f5;
        }

        .payment-number {
            font-size: 0.85rem;
            color: #6c757d;
            text-transform: uppercase;
            margin-bottom: 10px;
        }

        .payment-amount {
            font-size: 1.8rem;
            font-weight: 700;
            color: #2c3e50;
            margin-bottom: 15px;
        }

        .payment-date {
            font-size: 0.9rem;
            color: #6c757d;
            margin-bottom: 15px;
        }

        .payment-status {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .status-checkbox {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        .status-label {
            font-weight: 600;
            font-size: 0.9rem;
        }

        .status-label.paid {
            color: #28a745;
        }

        .status-label.pending {
            color: #ffc107;
        }

        .status-label.overdue {
            color: #dc3545;
        }

        .action-buttons {
            display: flex;
            gap: 10px;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 2px solid #e9ecef;
        }

        .btn-primary {
            flex: 1;
            padding: 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 1rem;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.3);
        }

        .btn-success {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        }

        .btn-success:hover {
            box-shadow: 0 8px 20px rgba(40, 167, 69, 0.3);
        }

        .btn-info {
            background: linear-gradient(135deg, #17a2b8 0%, #138496 100%);
        }

        .btn-whatsapp {
            background: linear-gradient(135deg, #25D366 0%, #128C7E 100%);
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #6c757d;
        }

        .empty-icon {
            font-size: 4rem;
            margin-bottom: 20px;
        }

        .summary-box {
            background: linear-gradient(135deg, #e3f2fd 0%, #f3e5f5 100%);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .summary-row {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid rgba(0,0,0,0.1);
        }

        .summary-row:last-child {
            border-bottom: none;
            font-weight: 700;
            font-size: 1.2rem;
            margin-top: 10px;
        }

        @media (max-width: 1024px) {
            .main-grid {
                grid-template-columns: 1fr;
            }

            .client-list {
                max-height: 300px;
            }

            .schedule-grid {
                grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            }
        }

        @media (max-width: 768px) {
            .stats-bar {
                grid-template-columns: repeat(2, 1fr);
            }

            .form-row {
                grid-template-columns: 1fr;
            }

            .client-meta {
                flex-direction: column;
                gap: 10px;
            }

            .schedule-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class='container'>
        <div class='header'>
            <h2>üí∞ Gesti√≥n de Planes de Pago Mensuales</h2>
            <div class='controls'>
                <div class='control-group'>
                    <label style='color: white;'>Mes:</label>
                    <select class='control-input' id='monthSelect'>
                        <option value='1'>Enero</option>
                        <option value='2'>Febrero</option>
                        <option value='3'>Marzo</option>
                        <option value='4'>Abril</option>
                        <option value='5'>Mayo</option>
                        <option value='6'>Junio</option>
                        <option value='7'>Julio</option>
                        <option value='8'>Agosto</option>
                        <option value='9'>Septiembre</option>
                        <option value='10'>Octubre</option>
                        <option value='11'>Noviembre</option>
                        <option value='12'>Diciembre</option>
                    </select>
                </div>
                <div class='control-group'>
                    <label style='color: white;'>A√±o:</label>
                    <select class='control-input' id='yearSelect'></select>
                </div>
                <button class='btn' onclick='loadData()'>üîÑ Actualizar</button>
            </div>
        </div>

        <div class='stats-bar'>
            <div class='stat-item'>
                <div class='stat-number' id='totalClients'>0</div>
                <div class='stat-label'>Clientes</div>
            </div>
            <div class='stat-item'>
                <div class='stat-number' id='totalPayments'>0</div>
                <div class='stat-label'>Cuotas Totales</div>
            </div>
            <div class='stat-item'>
                <div class='stat-number' id='paidPayments'>0</div>
                <div class='stat-label'>Cuotas Pagadas</div>
            </div>
            <div class='stat-item'>
                <div class='stat-number' id='pendingPayments'>0</div>
                <div class='stat-label'>Cuotas Pendientes</div>
            </div>
            <div class='stat-item'>
                <div class='stat-number' id='totalCollected'>$0</div>
                <div class='stat-label'>Total Recaudado</div>
            </div>
            <div class='stat-item'>
                <div class='stat-number' id='totalPending'>$0</div>
                <div class='stat-label'>Total Pendiente</div>
            </div>
        </div>

        <div class='main-grid'>
            <div class='client-list'>
                <div class='client-list-header'>
                    üìã Lista de Clientes
                </div>
                <div class='search-box'>
                    <input type='text' class='search-input' id='searchInput' placeholder='üîç Buscar cliente...'>
                </div>
                <div class='clients-container' id='clientsList'>
                    <div class='empty-state'>
                        <div class='empty-icon'>‚è≥</div>
                        <p>Cargando clientes...</p>
                    </div>
                </div>
            </div>

            <div class='payment-detail' id='paymentDetail'>
                <div class='empty-state'>
                    <div class='empty-icon'>üëà</div>
                    <h3>Seleccione un cliente</h3>
                    <p>Haga clic en un cliente para ver y gestionar su plan de pagos</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        let clients = [];
        let selectedClient = null;
        let currentMonth = new Date().getMonth() + 1;
        let currentYear = new Date().getFullYear();
        let paymentPlans = {};

        // Inicializar
        function init() {
            // Llenar a√±os
            const yearSelect = document.getElementById('yearSelect');
            for (let y = currentYear - 2; y <= currentYear + 1; y++) {
                const option = document.createElement('option');
                option.value = y;
                option.textContent = y;
                if (y === currentYear) option.selected = true;
                yearSelect.appendChild(option);
            }
            
            document.getElementById('monthSelect').value = currentMonth;
            
            loadData();
            
            // B√∫squeda en tiempo real
            document.getElementById('searchInput').addEventListener('input', filterClients);
        }

        // Cargar datos
        async function loadData() {
            currentMonth = parseInt(document.getElementById('monthSelect').value);
            currentYear = parseInt(document.getElementById('yearSelect').value);
            
            try {
                const response = await fetch('/api/clients');
                clients = await response.json();
                
                // Cargar planes de pago
                const plansResponse = await fetch(`/api/payment-plans?month=${currentMonth}&year=${currentYear}`);
                paymentPlans = await plansResponse.json();
                
                renderClientList();
                updateGlobalStats();
            } catch (error) {
                console.error('Error cargando datos:', error);
            }
        }

        // Renderizar lista de clientes
        function renderClientList() {
            const container = document.getElementById('clientsList');
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            
            let filteredClients = clients.filter(c => c.active);
            
            if (searchTerm) {
                filteredClients = filteredClients.filter(c => 
                    c.name.toLowerCase().includes(searchTerm) || 
                    (c.phone && c.phone.includes(searchTerm))
                );
            }
            
            if (filteredClients.length === 0) {
                container.innerHTML = `
                    <div class='empty-state'>
                        <div class='empty-icon'>üîç</div>
                        <p>No se encontraron clientes</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = filteredClients.map(client => {
                const plan = paymentPlans[client.id] || {};
                const paymentsCount = plan.payments_count || 0;
                const paid = plan.paid_count || 0;
                
                return `
                    <div class='client-item ${selectedClient && selectedClient.id === client.id ? 'active' : ''}' 
                         onclick='selectClient(${JSON.stringify(client)})'>
                        <div class='client-name'>${client.name}</div>
                        <div class='client-info'>
                            üìû ${client.phone || 'Sin tel√©fono'}<br>
                            üí≥ ${paid}/${paymentsCount} cuotas pagadas
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Seleccionar cliente
        async function selectClient(client) {
            selectedClient = client;
            renderClientList();
            
            // Cargar plan de pago del cliente
            try {
                const response = await fetch(`/api/payment-plans/${client.id}?month=${currentMonth}&year=${currentYear}`);
                const plan = await response.json();
                
                renderPaymentDetail(plan);
            } catch (error) {
                console.error('Error cargando plan:', error);
            }
        }

        // Renderizar detalle de pago
        function renderPaymentDetail(plan) {
            const container = document.getElementById('paymentDetail');
            
            const paymentsCount = plan.payments_count || 1;
            const amount = plan.monthly_amount || selectedClient.monthly_amount;
            const amountPerPayment = (amount / paymentsCount).toFixed(2);
            
            let totalPaid = 0;
            let totalPending = 0;
            let paidCount = 0;
            
            let paymentsHtml = '';
            
            for (let i = 1; i <= paymentsCount; i++) {
                const payment = (plan.payments || []).find(p => p.payment_number === i) || {
                    payment_number: i,
                    amount: amountPerPayment,
                    paid: false,
                    paid_date: null
                };
                
                const isPaid = payment.paid;
                const isOverdue = !isPaid && new Date() > new Date(currentYear, currentMonth, 0);
                
                let statusClass = isPaid ? 'paid' : (isOverdue ? 'overdue' : 'pending');
                let statusText = isPaid ? '‚úÖ Pagado' : (isOverdue ? '‚ùå Vencido' : '‚è≥ Pendiente');
                let statusLabelClass = isPaid ? 'paid' : (isOverdue ? 'overdue' : 'pending');
                
                if (isPaid) {
                    totalPaid += parseFloat(payment.amount);
                    paidCount++;
                } else {
                    totalPending += parseFloat(payment.amount);
                }
                
                paymentsHtml += `
                    <div class='payment-card ${statusClass}'>
                        <div class='payment-number'>Cuota #${i} de ${paymentsCount}</div>
                        <div class='payment-amount'>$${payment.amount}</div>
                        ${payment.paid_date ? `<div class='payment-date'>üìÖ Pagado: ${payment.paid_date}</div>` : ''}
                        <div class='payment-status'>
                            <input type='checkbox' class='status-checkbox' 
                                   ${isPaid ? 'checked' : ''}
                                   onchange='togglePayment(${selectedClient.id}, ${i}, this.checked, ${payment.amount})'>
                            <span class='status-label ${statusLabelClass}'>${statusText}</span>
                        </div>
                    </div>
                `;
            }
            
            container.innerHTML = `
                <div class='detail-header'>
                    <div class='client-title'>${selectedClient.name}</div>
                    <div class='client-meta'>
                        <span>üìû ${selectedClient.phone || 'Sin tel√©fono'}</span>
                        <span>üìÖ ${getMonthName(currentMonth)} ${currentYear}</span>
                        <span>üí∞ Total Mensual: $${amount}</span>
                    </div>
                </div>

                <div class='plan-config'>
                    <h3>‚öôÔ∏è Configuraci√≥n del Plan</h3>
                    <div class='form-row'>
                        <div class='form-group'>
                            <label class='form-label'>Cantidad de Cuotas al Mes</label>
                            <input type='number' class='form-input' id='paymentsCount' 
                                   value='${paymentsCount}' min='1' max='31'>
                        </div>
                        <div class='form-group'>
                            <label class='form-label'>Monto Total Mensual</label>
                            <input type='number' class='form-input' id='totalAmount' 
                                   value='${amount}' step='0.01'>
                        </div>
                        <div class='form-group'>
                            <label class='form-label'>Monto por Cuota</label>
                            <input type='number' class='form-input' id='amountPerPayment' 
                                   value='${amountPerPayment}' step='0.01' readonly>
                        </div>
                    </div>
                    <button class='btn-primary' onclick='updatePlan()'>üíæ Actualizar Plan</button>
                </div>

                <div class='summary-box'>
                    <div class='summary-row'>
                        <span>Cuotas Pagadas:</span>
                        <strong>${paidCount} de ${paymentsCount}</strong>
                    </div>
                    <div class='summary-row'>
                        <span>Total Recaudado:</span>
                        <strong style='color: #28a745;'>$${totalPaid.toFixed(2)}</strong>
                    </div>
                    <div class='summary-row'>
                        <span>Total Pendiente:</span>
                        <strong style='color: #dc3545;'>$${totalPending.toFixed(2)}</strong>
                    </div>
                    <div class='summary-row'>
                        <span>Total del Mes:</span>
                        <strong>$${amount}</strong>
                    </div>
                </div>

                <div class='payment-schedule'>
                    <h3>üìä Cronograma de Pagos</h3>
                    <div class='schedule-grid'>
                        ${paymentsHtml}
                    </div>
                </div>

                <div class='action-buttons'>
                    <button class='btn-primary btn-success' onclick='saveChanges()'>üíæ Guardar Cambios</button>
                    <button class='btn-primary btn-info' onclick='exportClientReport()'>üìä Exportar Reporte</button>
                    <button class='btn-primary btn-whatsapp' onclick='sendReminder()'>üí¨ Enviar Recordatorio</button>
                </div>
            `;
            
            // Actualizar c√°lculo autom√°tico
            document.getElementById('paymentsCount').addEventListener('input', updatePaymentCalculation);
            document.getElementById('totalAmount').addEventListener('input', updatePaymentCalculation);
        }

        // Actualizar c√°lculo de cuotas
        function updatePaymentCalculation() {
            const count = parseFloat(document.getElementById('paymentsCount').value) || 1;
            const total = parseFloat(document.getElementById('totalAmount').value) || 0;
            const perPayment = (total / count).toFixed(2);
            document.getElementById('amountPerPayment').value = perPayment;
        }

        // Toggle pago
        async function togglePayment(clientId, paymentNumber, paid, amount) {
            try {
                const response = await fetch('/api/payment-plans/toggle', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        client_id: clientId,
                        month: currentMonth,
                        year: currentYear,
                        payment_number: paymentNumber,
                        paid: paid,
                        amount: amount
                    })
                });
                
                if (response.ok) {
                    // Recargar datos
                    selectClient(selectedClient);
                    updateGlobalStats();
                } else {
                    alert('Error al actualizar el pago');
                }
            } catch (error) {
                console.error('Error:', error);
            }
        }

        // Actualizar plan
        async function updatePlan() {
            const paymentsCount = parseInt(document.getElementById('paymentsCount').value);
            const totalAmount = parseFloat(document.getElementById('totalAmount').value);
            
            if (!paymentsCount || !totalAmount) {
                alert('Por favor complete todos los campos');
                return;
            }
            
            try {
                const response = await fetch('/api/payment-plans/update', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        client_id: selectedClient.id,
                        month: currentMonth,
                        year: currentYear,
                        payments_count: paymentsCount,
                        monthly_amount: totalAmount
                    })
                });
                
                if (response.ok) {
                    alert('‚úÖ Plan actualizado correctamente');
                    selectClient(selectedClient);
                } else {
                    alert('‚ùå Error al actualizar el plan');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('‚ùå Error de conexi√≥n');
            }
        }

        // Guardar cambios
        function saveChanges() {
            alert('‚úÖ Todos los cambios han sido guardados autom√°ticamente');
        }

        // Exportar reporte del cliente
        function exportClientReport() {
            window.location.href = `/api/export-client-plan/${selectedClient.id}?month=${currentMonth}&year=${currentYear}`;
        }

        // Enviar recordatorio
        async function sendReminder() {
            if (!confirm('¬øEnviar recordatorio de pago por WhatsApp?')) return;
            
            try {
                const response = await fetch('/whatsapp/enqueue', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        client_id: selectedClient.id,
                        message: `Hola ${selectedClient.name}, te recordamos que tienes cuotas pendientes de pago. ¬°Gracias!`,
                        template: 'recordatorio'
                    })
                });
                
                if (response.ok) {
                    alert('‚úÖ Recordatorio enviado a la cola de WhatsApp');
                } else {
                    alert('‚ùå Error al enviar recordatorio');
                }
            } catch (error) {
                console.error('Error:', error);
            }
        }

        // Filtrar clientes
        function filterClients() {
            renderClientList();
        }

        // Actualizar estad√≠sticas globales
        function updateGlobalStats() {
            let totalClients = clients.filter(c => c.active).length;
            let totalPayments = 0;
            let paidPayments = 0;
            let totalCollected = 0;
            let totalPending = 0;
            
            Object.values(paymentPlans).forEach(plan => {
                totalPayments += plan.payments_count || 0;
                paidPayments += plan.paid_count || 0;
                totalCollected += plan.total_paid || 0;
                totalPending += plan.total_pending || 0;
            });
            
            document.getElementById('totalClients').textContent = totalClients;
            document.getElementById('totalPayments').textContent = totalPayments;
            document.getElementById('paidPayments').textContent = paidPayments;
            document.getElementById('pendingPayments').textContent = totalPayments - paidPayments;
            document.getElementById('totalCollected').textContent = `${totalCollected.toFixed(2)}`;
            document.getElementById('totalPending').textContent = `${totalPending.toFixed(2)}`;
        }

        // Obtener nombre del mes
        function getMonthName(month) {
            const months = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio',
                          'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
            return months[month - 1];
        }

        // Iniciar
        init();
    </script>
</body>
</html>